name: Build PR Preview Deployment

env:
  AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID}}
  AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_ID}}
  AUTH0_ISSUER: ${{ secrets.AUTH0_ISSUER}}
  GITHUB_ID: ${{ secrets.GH_ID}}
  GITHUB_SECRET: ${{ secrets.GH_SECRET}}
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  RAILWAY_CONFIG: ${{ secrets.RAILWAY_CONFIG }}
  PR_NUMBER: ${{ github.event.number }}

on: [pull_request]
jobs:
  deployment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: make-comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## 🧙 Building PR Deploy Preview
            Release ${{ github.sha }} ...
      - run: |
         mkdir .vercel
      - name: create-json
        uses: jsdaniell/create-json@v1.2.1
        with:
          name: 'project.json'
          json: ${{ secrets.VERCEL_CONFIG }}
          dir: '.vercel/'
      - name: Prepare and deploy
        id: prepare-and-deploy
        run: |
         npm i -g @railway/cli
         cd $HOME
         mkdir .railway
         cd .railway
         echo "$RAILWAY_CONFIG" > config.json
         cd $GITHUB_WORKSPACE
         #echo "👀 Check railway auth"
         #railway whoami
         RAILWAY_ENVIRONMENT="katamino-pr-$PR_NUMBER"
         echo "🚉 Railway Environment: $RAILWAY_ENVIRONMENT"
         railway environment $RAILWAY_ENVIRONMENT
         echo "👀 Check railway status?"
         railway status
         RAILWAY_VARIABLES=$(railway vars)
         DATABASE_URL=$(echo $RAILWAY_VARIABLES | grep -o "postgresql.*/railway")
         export DATABASE_URL=$DATABASE_URL
         echo "🛠️ npm install"
         npm install
         echo "👾 DB Push"
         npx prisma db push
         echo "🌱 DB Seed"
         npx prisma db seed > /dev/null
         echo "🚀 Vercel build"
         VERCEL_OUTPUT=$(vercel --token=${{ secrets.VERCEL_TOKEN }} --env DATABASE_URL=$DATABASE_URL --build-env DATABASE_URL=$DATABASE_URL)
         echo $VERCEL_OUTPUT
         echo "🏁 Finished"
         echo VERCEL_OUTPUT=$VERCEL_OUTPUT >> $GITHUB_OUTPUT
         FORTUNE=$(wget -O - https://fortuneapi.herokuapp.com/)
         FORTUNE_LINEFEED=$(echo $FORTUNE | sed 's/\\n/\'$'\n''/g')
         
         echo FORTUNE=$FORTUNE_LINEFEED >> $GITHUB_OUTPUT
      - name: make-comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## ✅ PR Deployment Ready 
            Release ${{ github.sha }} to ${{ steps.prepare-and-deploy.outputs.VERCEL_OUTPUT }}

            Fortune ${{steps.prepare-and-deploy.outputs.FORTUNE}}