---

name: "Build PR Preview Deployment"

env:
  RAILWAY_CONFIG: ${{ secrets.RAILWAY_CONFIG }}
on: [pull_request]
jobs:
  deployment:
    runs-on: ubuntu-latest
    environment: Preview
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Make / update deployment comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### 🧙 Building PR Deploy Preview for ${{ github.triggering_actor }}
            Changes: ${{ github.sha }} ...

      - name: "Make vercel configuration directory"
        run: |
         mkdir .vercel

      - name: Create vercel configuration file
        uses: jsdaniell/create-json@v1.2.1
        with:
          name: 'project.json'
          json: ${{ secrets.VERCEL_CONFIG }}
          dir: '.vercel/'

      - name: Prepare and deploy feature branch
        id: prepare-and-deploy
        run: |
         npm i -g @railway/cli
         cd $HOME
         mkdir .railway
         cd .railway
         echo "$RAILWAY_CONFIG" > config.json
         cd $GITHUB_WORKSPACE
         echo "👀 Check railway auth"
         railway whoami
         RAILWAY_ENVIRONMENT="katamino-pr-${{ github.event.number }}"
         echo "🚉 Railway Environment: $RAILWAY_ENVIRONMENT"
         railway environment $RAILWAY_ENVIRONMENT
         echo "👀 Check railway status?"
         railway status
         RAILWAY_VARIABLES=$(railway vars)
         DATABASE_URL="$(echo $RAILWAY_VARIABLES | \
           grep -o "postgresql.*/railway")"
         export DATABASE_URL=$DATABASE_URL
         echo "🛠️ npm install"
         npm install
         #👇 reset DB, migrate & seed
         echo "🌈 prisma migrate reset --force"
         npx prisma migrate reset --force > /dev/null
         #echo "🌱 DB Seed"
         #npx prisma db seed > /dev/null
         echo "🚀 Vercel build"
         VERCEL_OUTPUT=$(vercel --token=${{ secrets.VERCEL_TOKEN }} \
           --env DATABASE_URL=$DATABASE_URL --build-env \ 
           DATABASE_URL=$DATABASE_URL)
         echo $VERCEL_OUTPUT
         echo "🏁 Finished"
         echo VERCEL_OUTPUT=$VERCEL_OUTPUT >> $GITHUB_OUTPUT

      - name: Update deployment comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ✅ PR Deployment Ready for ${{ github.triggering_actor }}
            Deployed ${{ github.sha }} to \
              ${{ steps.prepare-and-deploy.outputs.VERCEL_OUTPUT }}
